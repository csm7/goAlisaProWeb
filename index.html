<!DOCTYPE html>
<html>
<head>
    <title>UGV Telemetry</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>UGV Telemetry</h1>
    <div style="width: 75%;">
        <canvas id="throttleChart"></canvas>
    </div>
    <div id="telemetry"></div>

    <h2>Configuration</h2>
    <form id="configForm">
        <label for="maxSpeed">Max Speed:</label>
        <input type="number" id="maxSpeed" name="maxSpeed"><br><br>
        <label for="turnSpeed">Turn Speed:</label>
        <input type="number" id="turnSpeed" name="turnSpeed"><br><br>
        <button type="submit">Update Configuration</button>
    </form>

    <script>
        const telemetryDiv = document.getElementById('telemetry');
        const throttleCanvas = document.getElementById('throttleChart').getContext('2d');

        const throttleChart = new Chart(throttleCanvas, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Throttle',
                    data: [],
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom'
                    }
                }
            }
        });

        const ws = new WebSocket("ws://localhost:8080/ws");

        ws.onopen = function(event) {
            console.log("WebSocket is open now.");
        };

        ws.onmessage = function(event) {
            const telemetryData = JSON.parse(event.data);
            telemetryDiv.innerHTML = `<pre>${JSON.stringify(telemetryData, null, 2)}</pre>`;
            updateChart(throttleChart, telemetryData.timestamp, telemetryData.throttle);
        };

        function updateChart(chart, label, data) {
            chart.data.labels.push(label);
            chart.data.datasets.forEach((dataset) => {
                dataset.data.push(data);
            });
            chart.update();
        }

        document.getElementById('configForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const maxSpeed = document.getElementById('maxSpeed').value;
            const turnSpeed = document.getElementById('turnSpeed').value;
            const config = {
                max_speed: parseFloat(maxSpeed),
                turn_speed: parseFloat(turnSpeed)
            };

            fetch('/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            });
        });
    </script>
</body>
</html>
